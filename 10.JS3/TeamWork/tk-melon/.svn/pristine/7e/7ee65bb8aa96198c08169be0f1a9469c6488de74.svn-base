<?php

    if (isset($_REQUEST['action'])) {
        $response = array();

        switch($_REQUEST['action']) {

            case 'register':
                $result = register(
                    $_REQUEST['name'],
                    $_REQUEST['email'],
                    $_REQUEST['password']);

                if ($result)
                {
                    $response['success'] = true;
                    $response['message'] = 'Congratulations ' .
                        $_REQUEST["name"] . ' you are now registerd!';
                }
                else
                {
                    $response['error'] = true;
                    $response['message'] = 'Oops.. This email is already registered..';
                }

                break;

            case 'login':
                $result = login(
                    $_REQUEST['email'],
                    $_REQUEST['password']);

                if ($result)
                {
                    $response['success'] = true;
                    $response['userid'] = $result;
                }
                else
                {
                    $response['error'] = true;
                    $response['userid'] = null;
                }

                break;
        }

        $encoded = json_encode($response);
        header('Content-type: application/json');
        exit($encoded); 
    }

    function register($name, $email, $password)
    {
        $db = new SQLite3("db.db3");

        $tablename = "users";
        $password=md5($password);

        $query = "SELECT * FROM $tablename WHERE (email = '$email')";
        $result = $db -> querySingle($query);

        if ($result)
        {
            return false;
        }

        $query = "INSERT INTO $tablename(name, password, email)
                    VALUES ('$name', '$password', '$email')";
        $result = $db -> exec($query);

        return true;
    }

    function login($email, $password)
    {
        $db = new SQLite3("db.db3");

        $tablename = "users";
        $password=md5($password);

        $query = "SELECT id FROM $tablename WHERE (email = '$email') AND (password = '$password')";
        $result = $db -> querySingle($query);

        return $result;
    }
?>