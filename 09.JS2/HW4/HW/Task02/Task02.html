<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Throw trash game</title>
	<style>
		#wrapper, body, html {
			min-height: 100%;
			background: #ccc;
		}
		#trashCan{
			width: 135px;
			height: 173px;
			background: url("TrashCan.png");
		}
		.trash{
			width: 77px;
			height: 62px;
			background: url("Trash.png");
			cursor: pointer;
		}
	</style>
	<script>
		/*
		Task02

		Using the exercise with the bucket implement functionality for high-score
		- When the user cleans all the trash, he is asked for a nickname and his score is saved in the local storage
		- The score of the user is the time that took him to clean the trash
			- Implement a high-score board, that is visible on page load and shows the top 5 scores 
		- The 5 users that cleaned the trash fastest
		*/
		var NUMBER_OF_TRASH = 20;
		var HIGHSCORE_RESULTS = 5;

		window.addEventListener('load', function () {
	        wrapperDiv = document.getElementById("wrapper");
	        intialize();
	    }, false);

	    function intialize(){
	    	var highScoreBoard = localStorage.getObject('highScoreBoard');

	    	if (highScoreBoard === null){
	    		localStorage.setObject('highScoreBoard', []);
	    	}

	    	getHighScores();
	    }

	    function startGame (){
	    	cleanPlayfield();
			generateTrash(NUMBER_OF_TRASH);	  
			stopWatchStart = new Date().getTime();
	    }

	    function cleanPlayfield(){
	    	var trashDivs = document.getElementsByClassName("trash");
	    	for (var i = 0; i < trashDivs.length; i++) {
	    		wrapperDiv.removeChild(trashDivs[i]);
	    	};
	    }

	    function gameEnd(){
	    	var playerTime = (new Date().getTime() - stopWatchStart) / 1000;
	    	var message = "Congratulations your time is: " + playerTime + " seconds. Please enter your name:";
	    	var playerName = prompt(message,"Your name");

	    	manageHighscoreBoard({"playerName" : playerName, 'playerTime' : playerTime})
	    }

	    function manageHighscoreBoard(newHighScore){
	    	var highScoreBoard = localStorage.getObject('highScoreBoard');

	    	if (highScoreBoard.length == HIGHSCORE_RESULTS){
	    		var lastHighScoreIndex = highScoreBoard.length - 1;
	    		if (newHighScore.playerTime < highScoreBoard[lastHighScoreIndex].playerTime){
	    			highScoreBoard[lastHighScoreIndex] = newHighScore;
	    		}
	    	}
	    	else{
	    		highScoreBoard.push(newHighScore);
	    	}

    		highScoreBoard.sort(function (previousElement, nextElement){
    			return previousElement.playerTime - nextElement.playerTime;
    		})

	    	localStorage.setObject('highScoreBoard', highScoreBoard);
	    }

	    function getHighScores(){
	    	var highScoreBoard = localStorage.getObject('highScoreBoard');
	    	var highScoresBoardDisplay;

	    	if (highScoreBoard.length === 0){
	    		highScoresBoardDisplay = "No highscores!";
	    	}
	    	else{
		    	var highScoresMessage = [];
		    	for (var i = 0; i < highScoreBoard.length; i++) {
		    		highScoresMessage.push(highScoreBoard[i].playerName + " : " + highScoreBoard[i].playerTime);
		    	};

		    	highScoresBoardDisplay = highScoresMessage.join("\n");
	    	}

	    	alert("Highscore Board: \n\n" + highScoresBoardDisplay);
	    }

		function generateTrash(number){
			var docFragment = document.createDocumentFragment();

			for (var i = 0; i < number; i++) {
				var newTrashDiv = generateTrashDiv();
				newTrashDiv.id = i;
				docFragment.appendChild(newTrashDiv);
			};

			wrapperDiv.appendChild(docFragment);
		}

		function generateTrashDiv(){
			var newTrashDiv = document.createElement("div");
			newTrashDiv.classList.add("trash");
			newTrashDiv.style.position = "absolute";
			newTrashDiv.style.top = ((Math.random() * 600) | 0) + "px";
			newTrashDiv.style.left = 200 + ((Math.random() * 400) | 0) + "px";

			newTrashDiv.draggable = "true";
			newTrashDiv.addEventListener('dragstart', trashDrag, false);
			return newTrashDiv;
		}

		function trashDrag(ev){
    		ev.dataTransfer.setData("draggedTrash", ev.target.id);
		}

		function dropTrash(ev){
        	ev.preventDefault();
			ev.target.style.backgroundImage = "url(TrashCan.png)";

        	var trashDivId = ev.dataTransfer.getData("draggedTrash");
        	var trashDiv = document.getElementById(trashDivId);
	    	wrapperDiv.removeChild(trashDiv);

	    	var trashDivs = document.getElementsByClassName("trash");
	    	if (trashDivs.length === 0){
	    		gameEnd();
	    	}
		}

		function trashDragOver(ev){
			ev.preventDefault();

			ev.target.style.backgroundImage = "url(TrashCanOpen.png)";
		}

		function trashDragLeave(ev){
			ev.preventDefault();

			ev.target.style.backgroundImage = "url(TrashCan.png)";
		}

		(function() {
		    if (!Storage.prototype.setObject) {
		        Storage.prototype.setObject = function setObject(key, obj) {
		            var jsonObj = JSON.stringify(obj);
		            this.setItem(key, jsonObj);
		        };

		    }
		    if (!Storage.prototype.getObject) {
		        Storage.prototype.getObject = function getObject(key) {
		            var jsonObj = this.getItem(key);
		            var obj = JSON.parse(jsonObj);
		            return obj;
		        };
		    }
		})();
	</script>
</head>
<body>
	<div id="wrapper">
		<div id="trashCan" ondrop="dropTrash(event)" ondragover="trashDragOver(event)" ondragleave="trashDragLeave(event)"></div>
		<button id="startGame" onclick="startGame(event)">Start game</button>
		<button id="getHighScores" onclick="getHighScores(event)">Highscores</button>
	</div>
</body>
</html>